<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>실험 데이터 수집 · 반별 시각화(임베디드 실시간 가능)</title>
  <style>
    :root { --bg:#f8fafc; --fg:#0f172a; --muted:#64748b; --card:#ffffff; --border:#e2e8f0; --accent:#0ea5e9; }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,.04);padding:16px}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1024px){.row{grid-template-columns:1fr 2fr}}
    h1{font-size:18px;margin:0} h2{font-size:16px;margin:0 0 6px} small{color:var(--muted)}
    .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn.primary{background:#0f172a;color:#fff;border-color:#0f172a}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff}
    table{width:100%;border-collapse:collapse} th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    .flex{display:flex;gap:8px;align-items:center} .space{height:8px}
    .right{margin-left:auto}
    .notice{background:#fff4e5;border:1px solid #facc15;padding:10px;border-radius:12px}
    .header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:saturate(1.1) blur(6px);border-bottom:1px solid var(--border);z-index:10}
    .header .container{display:flex;align-items:center;gap:12px;padding-top:10px;padding-bottom:10px}
    .logo{width:36px;height:36px;border-radius:12px;background:#0f172a;color:#fff;display:grid;place-items:center;font-weight:700}
    canvas{width:100%;height:360px;border:1px solid var(--border);border-radius:12px;background:#fff}
    code{background:#f1f5f9;padding:2px 6px;border-radius:8px}
  </style>
  <!-- Firebase (실시간에만 필요; 차단 시 로컬 저장소 모드로 동작) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="logo">L</div>
      <div>
        <h1>실험 데이터 수집 · 반별 시각화 <small>(임베디드 실시간 가능)</small></h1>
        <small>학생 입력 → 표 누적 → 그래프 생성 · Firebase JSON을 파일 안에 직접 붙여넣어 실시간 동기화</small>
      </div>
      <span class="right"></span>
    </div>
  </div>

  <div class="container">
    <div class="notice" id="howto">
      <b>실시간 사용법:</b> 이 파일을 메모장으로 열어
      <code>window.EMBEDDED_FIREBASE_CONFIG = {/* 여기에 JSON 붙여넣기 */};</code>
      부분에 Firebase에서 복사한 JSON을 그대로 넣고 저장하세요.
      (예: <code>{"apiKey":"...","authDomain":"...","projectId":"...","appId":"..."}</code>)
      <br/>Firebase 스크립트가 차단된 네트워크에서는 실시간이 동작하지 않으며, 이 경우 자동으로 브라우저 저장소 모드로 실행됩니다.
    </div>

    <div class="row" style="margin-top:12px">
      <section class="card">
        <div class="flex" style="justify-content:space-between">
          <h2>데이터 입력</h2>
          <div class="flex">
            <select id="classSelect"></select>
          </div>
        </div>
        <div class="space"></div>
        <form id="inputForm">
          <div class="flex" style="gap:12px">
            <div style="flex:1"><small>모둠</small><input id="groupInput" placeholder="예: 3" /></div>
            <div style="flex:1"><small>이름</small><input id="studentInput" placeholder="예: 김학생" /></div>
          </div>
          <div id="dynamicFields" class="flex" style="flex-wrap:wrap;gap:12px;margin-top:12px"></div>
          <div class="space"></div>
          <div class="flex"><button class="btn primary" type="submit">제출</button><button class="btn" type="button" id="resetBtn">초기화</button></div>
          <small id="storageMode" style="display:block;margin-top:8px;color:var(--muted)">현재 저장 방식: 브라우저 저장소</small>
        </form>

        <div class="space"></div><div class="space"></div>
        <h3 style="margin:0 0 8px">반 관리</h3>
        <div class="flex">
          <input id="newClassInput" placeholder="새 반(예: 1-3, 2-1)" />
          <button class="btn" id="addClassBtn">추가</button>
        </div>
        <div id="classChips" class="flex" style="flex-wrap:wrap;margin-top:8px"></div>
      </section>

      <section>
        <div class="card">
          <div class="flex" style="justify-content:space-between">
            <h2>데이터 표 (<span id="currentClassLabel"></span>)</h2>
            <div class="flex">
              <button class="btn" id="exportBtn">CSV 내보내기</button>
              <button class="btn" id="clearBtn">이 반 데이터 초기화</button>
            </div>
          </div>
          <div class="space"></div>
          <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
            <table id="dataTable"></table>
          </div>
        </div>

        <div class="space"></div>

        <div class="card">
          <div class="flex" style="justify-content:space-between">
            <h2>시각화</h2>
            <small class="muted">그래프는 선택 반의 데이터만 사용합니다.</small>
          </div>
          <div class="space"></div>
          <div class="row" style="grid-template-columns:260px 1fr">
            <div class="card" style="padding:12px">
              <div style="display:grid;gap:8px">
                <label><small>차트 유형</small>
                  <select id="chartType">
                    <option value="bar">막대</option>
                    <option value="line">꺾은선</option>
                    <option value="scatter">산점도</option>
                  </select>
                </label>
                <div id="groupOptions">
                  <label><small>집계 기준</small><select id="groupBy"></select></label>
                  <label><small>집계 값(Y)</small><select id="yField"></select></label>
                  <label><small>집계 방식</small>
                    <select id="agg">
                      <option value="mean">평균</option>
                      <option value="sum">합</option>
                      <option value="min">최솟값</option>
                      <option value="max">최댓값</option>
                      <option value="count">개수</option>
                    </select>
                  </label>
                </div>
                <div id="scatterOptions" style="display:none">
                  <label><small>X축(숫자)</small><select id="xField"></select></label>
                  <label><small>Y축(숫자)</small><select id="yFieldScatter"></select></label>
                </div>
              </div>
            </div>
            <div><canvas id="chart"></canvas></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // 1) 여기에 붙여넣으세요 — Firebase 콘솔에서 복사한 JSON(중괄호 포함)을 = 뒤에 넣고 세미콜론 유지
    // 예: window.EMBEDDED_FIREBASE_CONFIG = {"apiKey":"...","authDomain":"...","projectId":"...","appId":"..."};
    window.EMBEDDED_FIREBASE_CONFIG = null; // <-- null을 JSON 객체로 바꾸면 실시간 활성화

    // 2) 공통 로직
    const LS_KEYS = { records:"lab_records_v1", fields:"lab_fields_v1", classes:"lab_classes_v1" };
    const DEFAULT_CLASSES = ["1-6","1-7","1-8","1-9","1-10"];
    const $ = (s)=>document.querySelector(s), $$=(s)=>Array.from(document.querySelectorAll(s));
    const uid = ()=> Date.now() + "_" + Math.random().toString(36).slice(2,9);
    const saveLS=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    co
