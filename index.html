<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>실험 데이터 수집 · 반별 실시간 시각화</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Recharts (UMD) -->
  <script crossorigin src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <!-- Firebase compat (optional, only used if config is provided) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <!-- Babel for JSX in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html,body{height:100%}body{background:#f8fafc}</style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;
    const { ResponsiveContainer, BarChart, Bar, LineChart, Line, ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, Legend } = Recharts;
    const LS_KEYS = { records:'lab_records_v1', fields:'lab_fields_v1', classes:'lab_classes_v1', firebase:'lab_firebase_config_v1' };
    const DEFAULT_CLASSES = ["1-6","1-7","1-8","1-9","1-10"];
    const uid = ()=> Date.now() + "_" + Math.random().toString(36).slice(2,9);
    const saveLS=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const loadLS=(k,fb)=>{try{const v=JSON.parse(localStorage.getItem(k)||'null');return v??fb;}catch{return fb;}};
    const fb = { enabled:false, app:null, db:null };
    async function initFirebaseIfNeeded(config){
      try{
        if(!config||!config.apiKey) return false;
        if(fb.enabled&&fb.app) return true;
        if(!window.firebase) return false;
        if(firebase.apps && firebase.apps.length){ fb.app=firebase.apps[0]; } else { fb.app=firebase.initializeApp(config); }
        fb.db = firebase.firestore(); fb.enabled = true; return true;
      }catch(e){ console.error(e); return false; }
    }
    async function fbAddRecord(r){ return fb.db.collection('lab_records').add(r); }
    function fbSubscribeAllRecords(onData){
      return fb.db.collection('lab_records').orderBy('timestamp','asc').onSnapshot(s=>{
        onData(s.docs.map(d=>({id:d.id, ...d.data()})));
      });
    }
    function isNumericField(f){ return f?.type==='number'; }
    function LabCollector(){
      const [classes, setClasses] = useState(()=>loadLS(LS_KEYS.classes, DEFAULT_CLASSES));
      const [selectedClass, setSelectedClass] = useState(classes[0]||'1-1');
      const [fields, setFields] = useState(()=>loadLS(LS_KEYS.fields,[{id:uid(), name:'측정값', type:'number'}]));
      const [records, setRecords] = useState(()=>loadLS(LS_KEYS.records,[]));
      const [firebaseConfig, setFirebaseConfig] = useState(()=>loadLS(LS_KEYS.firebase, {}));
      const [firebaseReady, setFirebaseReady] = useState(false);
      const [helpOpen, setHelpOpen] = useState(false);
      const [settingsOpen, setSettingsOpen] = useState(false);
      const [fieldPanelOpen, setFieldPanelOpen] = useState(false);
      useEffect(()=>{
        let unsub=null;
        (async()=>{
          const ok = await initFirebaseIfNeeded(firebaseConfig); setFirebaseReady(ok);
          if(ok){ unsub = fbSubscribeAllRecords(arr=>setRecords(arr)); }
          else{
            const sync=()=>setRecords(loadLS(LS_KEYS.records,[]));
            window.addEventListener('storage', sync); return ()=>window.removeEventListener('storage', sync);
          }
        })(); return ()=>{ if(unsub) unsub(); };
      },[firebaseConfig]);
      useEffect(()=>saveLS(LS_KEYS.fields,fields),[fields]);
      useEffect(()=>saveLS(LS_KEYS.classes,classes),[classes]);
      useEffect(()=>saveLS(LS_KEYS.firebase,firebaseConfig),[firebaseConfig]);
      const [form,setForm]=useState({groupId:'',student:''}); const [formValues,setFormValues]=useState({});
      function resetForm(){ setForm({groupId:'',student:''}); setFormValues({}); }
      function handleSubmit(e){
        e.preventDefault();
        for(const f of fields){ if(f.type==='number'){ const raw=formValues[f.id]; if(raw!=='' && raw!==undefined && isNaN(Number(raw))) return alert(`'${f.name}'에는 숫자만 입력하세요.`); } }
        const rec={ id:uid(), timestamp:Date.now(), classId:selectedClass, groupId:form.groupId||'', student:form.student||'', values:fields.reduce((a,f)=>{const raw=formValues[f.id]; a[f.name]= f.type==='number'?(raw===''||raw===undefined?null:Number(raw)):(raw??''); return a;},{}) };
        if(firebaseReady){ fbAddRecord(rec).catch(e=>alert('Firebase 저장 오류: '+(e?.message||e))); } else { const next=[...records,rec]; setRecords(next); saveLS(LS_KEYS.records,next); }
        resetForm();
      }
      function addField(type='number'){ const name=prompt('필드 이름'); if(!name) return; setFields(p=>[...p,{id:uid(),name,type}]);}
      function removeField(id){ if(!confirm('필드 삭제? 기존 데이터의 해당 컬럼은 비게 됩니다.')) return; setFields(p=>p.filter(f=>f.id!==id)); }
      function renameField(id){ const f=fields.find(x=>x.id===id); if(!f) return; const name=prompt('새 이름', f.name); if(!name) return; setFields(p=>p.map(x=>x.id===id?{...x,name}:x)); }
      const [newClass,setNewClass]=useState('');
      function addClass(){ const c=(newClass||'').trim(); if(!c) return; if(classes.includes(c)) return alert('이미 있음'); const next=[...classes,c]; setClasses(next); setNewClass(''); setSelectedClass(c); }
      function removeClass(c){ if(!confirm(c+' 반을 목록에서 제거할까요?')) return; const next=classes.filter(x=>x!==c); setClasses(next); if(selectedClass===c) setSelectedClass(next[0]||'');}
      const visibleRecords = useMemo(()=>records.filter(r=>r.classId===selectedClass),[records,selectedClass]);
      const numericFieldNames = fields.filter(isNumericField).map(f=>f.name);
      const [chartType,setChartType]=useState('bar'); const [xField,setXField]=useState('groupId'); const [yField,setYField]=useState(numericFieldNames[0]||'측정값'); const [groupBy,setGroupBy]=useState('groupId'); const [agg,setAgg]=useState('mean');
      const tableColumns = useMemo(()=>[{key:'timestamp',label:'시간'},{key:'classId',label:'반'},{key:'groupId',label:'모둠'},{key:'student',label:'이름'}, ...fields.map(f=>({key:'values.'+f.name,label:f.name}))],[fields]);
      function aggregate(data, byKey, valueKey, agg){
        if(!byKey) return []; const groups=new Map();
        for(const r of data){ const key=(byKey==='classId'||byKey==='groupId'||byKey==='student')?r[byKey]:r.values?.[byKey]; const v=valueKey==='count'?1:r.values?.[valueKey]; if(!groups.has(key)) groups.set(key,[]); groups.get(key).push(v);}
        const out=[]; for(const [k,arr] of groups){ if(!arr||arr.length===0) continue; let val=null; const nums=arr.map(x=>x==null?NaN:Number(x)).filter(x=>!Number.isNaN(x)); switch(agg){case'count':val=arr.length;break;case'sum':val=nums.reduce((a,b)=>a+b,0);break;case'min':val=Math.min(...nums);break;case'max':val=Math.max(...nums);break;default:val=nums.reduce((a,b)=>a+b,0)/(nums.length||1);} out.push({[xField]:k,[yField]:val});} return out;
      }
      const chartData = useMemo(()=>{
        if(chartType==='scatter'){ return visibleRecords.map(r=>({x:r.values?.[xField]??(xField==='groupId'?r.groupId:xField==='student'?r.student:r[xField]), y:r.values?.[yField], name:r.groupId||r.student||r.classId})).filter(d=>typeof d.x==='number' && typeof d.y==='number'); }
        const byKey = groupBy && groupBy!=='none' ? groupBy : null; if(!byKey) return []; return aggregate(visibleRecords, byKey, yField, agg);
      },[visibleRecords,chartType,xField,yField,groupBy,agg]);
      return (<div className="min-h-screen bg-slate-50 text-slate-900">
        <header className="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
          <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3 justify-between">
            <div className="flex items-center gap-3">
              <div className="w-9 h-9 rounded-2xl bg-slate-900 text-white grid place-items-center font-bold">L</div>
              <div><h1 className="text-lg font-bold">실험 데이터 수집 · 반별 실시간 시각화</h1><p className="text-xs text-slate-500">학생 입력 → 표 누적 → 그래프 자동 생성</p></div>
            </div>
            <div className="flex items-center gap-2">
              <button className="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-sm" onClick={()=>setHelpOpen(v=>!v)}>? 도움말</button>
              <button className="px-3 py-1.5 rounded-xl border text-sm" onClick={()=>setFieldPanelOpen(v=>!v)}>✚ 필드 설정</button>
              <button className="px-3 py-1.5 rounded-xl border text-sm" onClick={()=>setSettingsOpen(v=>!v)}>⚙ Firebase</button>
            </div>
          </div>
        </header>
        <div className="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
          <section className="lg:col-span-1">
            <div className="bg-white rounded-2xl shadow-sm border p-4">
              <div className="flex items-center justify-between">
                <h2 className="text-base font-semibold">데이터 입력</h2>
                <select className="border rounded-xl px-2 py-1" value={selectedClass} onChange={e=>setSelectedClass(e.target.value)}>{classes.map(c=><option key={c} value={c}>{c}</option>)}</select>
              </div>
              <form onSubmit={handleSubmit} className="mt-3 space-y-3">
                <div className="grid grid-cols-2 gap-3">
                  <div><label className="text-xs text-slate-600">모둠</label><input className="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="예: 3" value={form.groupId} onChange={e=>setForm(p=>({...p,groupId:e.target.value}))}/></div>
                  <div><label className="text-xs text-slate-600">이름</label><input className="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="예: 김학생" value={form.student} onChange={e=>setForm(p=>({...p,student:e.target.value}))}/></div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {fields.map(f=>(<div key={f.id}><label className="text-xs text-slate-600">{f.name}{f.type==='number'?' (숫자)':''}</label><input className="w-full mt-1 px-3 py-2 border rounded-xl" type={f.type==='number'?'number':'text'} step="any" value={ (formValues[f.id]??'') } onChange={e=>setFormValues(p=>({...p,[f.id]:e.target.value})) }/></div>))}
                </div>
                <div className="flex items-center gap-2 pt-2">
                  <button className="px-4 py-2 rounded-xl bg-slate-900 text-white" type="submit">제출</button>
                  <button className="px-4 py-2 rounded-xl border" type="button" onClick={resetForm}>초기화</button>
                </div>
                <p className="text-xs text-slate-500">현재 저장 방식: {firebaseReady?'Firebase(실시간)':'브라우저 저장소'}</p>
              </form>
              <div className="mt-5 border-t pt-4">
                <h3 className="text-sm font-semibold mb-2">반 관리</h3>
                <div className="flex gap-2"><input className="flex-1 px-3 py-2 border rounded-xl" placeholder="새 반(예: 1-3, 2-1)" onChange={e=>setNewClass(e.target.value)} /><button className="px-3 py-2 rounded-xl border" onClick={addClass}>추가</button></div>
                <div className="flex flex-wrap gap-2 mt-2 text-xs">{classes.map(c=>(<span key={c} className="inline-flex items-center gap-1 px-2 py-1 rounded-full border">{c}<button className="text-slate-500" onClick={()=>removeClass(c)}>×</button></span>))}</div>
              </div>
            </div>
          </section>
          <section className="lg:col-span-2">
            <div className="bg-white rounded-2xl shadow-sm border p-4">
              <div className="flex items-center justify-between">
                <h2 className="text-base font-semibold">데이터 표 (선택 반: {selectedClass})</h2>
                <div className="flex items-center gap-2">
                  <button className="px-3 py-1.5 rounded-xl border text-sm" onClick={()=>{ const vis=visibleRecords; if(!vis.length) return alert('내보낼 데이터가 없습니다.'); const rows=vis.map(r=>({시간:new Date(r.timestamp).toLocaleString(), 반:r.classId, 모둠:r.groupId, 이름:r.student, ...(r.values||{})})); const replacer=(k,v)=> (v==null?'':v); const header=Object.keys(rows[0]||{}); const csv=[ header.join(','), ...rows.map(row=> header.map(field=>JSON.stringify(replacer(field,row[field]))).join(',')) ].join('\\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='records_'+selectedClass+'.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); }}>CSV 내보내기</button>
                  <button className="px-3 py-1.5 rounded-xl border text-sm" onClick={()=>{ if(!confirm('이 반의 로컬 데이터를 모두 삭제할까요?')) return; const rest=records.filter(r=>r.classId!==selectedClass); setRecords(rest); saveLS(LS_KEYS.records, rest); }}>이 반 데이터 초기화</button>
                </div>
              </div>
              <div className="mt-3 overflow-auto border rounded-xl">
                <table className="min-w-full text-sm">
                  <thead className="bg-slate-50 border-b">
                    <tr>{[{key:'timestamp',label:'시간'},{key:'classId',label:'반'},{key:'groupId',label:'모둠'},{key:'student',label:'이름'}, ...fields.map(f=>({key:'values.'+f.name,label:f.name}))].map(col=>(<th key={col.key} className="text-left px-3 py-2 whitespace-nowrap font-semibold">{col.label}</th>))}</tr>
                  </thead>
                  <tbody>{visibleRecords.length===0 ? (<tr><td className="px-3 py-4 text-slate-500" colSpan={4+fields.length}>아직 데이터가 없습니다. 좌측 폼에서 제출해 보세요.</td></tr>) : visibleRecords.map(r=>(<tr key={r.id} className="border-b hover:bg-slate-50/50"><td className="px-3 py-2 whitespace-nowrap">{new Date(r.timestamp).toLocaleString()}</td><td className="px-3 py-2 whitespace-nowrap">{r.classId}</td><td className="px-3 py-2 whitespace-nowrap">{r.groupId}</td><td className="px-3 py-2 whitespace-nowrap">{r.student}</td>{fields.map(f=>(<td key={r.id+'-'+f.id} className="px-3 py-2">{r.values?.[f.name]==null?'':String(r.values?.[f.name])}</td>))}</tr>))}</tbody>
                </table>
              </div>
            </div>
            <div className="mt-6 bg-white rounded-2xl shadow-sm border p-4">
              <div className="flex items-center justify-between"><h2 className="text-base font-semibold">시각화</h2><div className="text-xs text-slate-500">그래프는 선택 반의 데이터만 사용합니다.</div></div>
              <div className="mt-3 grid grid-cols-1 lg:grid-cols-4 gap-3">
                <div className="grid grid-cols-2 lg:grid-cols-1 gap-3">
                  <div><label className="text-xs text-slate-600">차트 유형</label><select className="w-full mt-1 px-2 py-2 border rounded-xl" value={chartType} onChange={e=>setChartType(e.target.value)}><option value="bar">막대</option><option value="line">꺾은선</option><option value="scatter">산점도</option></select></div>
                  {chartType!=='scatter'? (<>
                    <div><label className="text-xs text-slate-600">집계 기준</label><select className="w-full mt-1 px-2 py-2 border rounded-xl" value={groupBy} onChange={e=>setGroupBy(e.target.value)}><option value="groupId">모둠</option><option value="student">이름</option><option value="classId">반</option>{fields.filter(f=>f.type==='text').map(f=>(<option key={f.id} value={f.name}>{f.name}</option>))}</select></div>
                    <div><label className="text-xs text-slate-600">집계 값(Y)</label><select className="w-full mt-1 px-2 py-2 border rounded-xl" value={yField} onChange={e=>setYField(e.target.value)}>{(fields.filter(isNumericField).map(n=>(<option key={n.name} value={n.name}>{n.name}</option>)))}</select></div>
                    <div><label className="text-xs text-slate-600">집계 방식</label><select className="w-full mt-1 px-2 py-2 border rounded-xl" value={agg} onChange={e=>setAgg(e.target.value)}><option value="mean">평균</option><option value="sum">합</option><option value="min">최솟값</option><option value="max">최댓값</option><option value="count">개수</option></select></div>
                  </>) : (<>
                    <div><label className="text-xs text-slate-600">X축(숫자)</label><select className="w-full mt-1 px-2 py-2 border rounded-xl" value={xField} onChange={e=>setXField(e.target.value)}>{fields.filter(isNumericField).map(f=>(<option key={f.name} value={f.name}>{f.name}</option>))}</select></div>
                    <div><label className="text-xs text-slate-600">Y축(숫자)</label><select className="w-full mt-1 px-2 py-2 border rounded-xl" value={yField} onChange={e=>setYField(e.target.value)}>{fields.filter(isNumericField).map(f=>(<option key={f.name} value={f.name}>{f.name}</option>))}</select></div>
                  </>)}
                </div>
                <div className="lg:col-span-3 h-[360px] w-full border rounded-xl p-2">
                  {chartType==='bar' && (<ResponsiveContainer width="100%" height="100%"><BarChart data={chartData} margin={{top:10,right:20,left:0,bottom:10}}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey={xField}/><YAxis/><Tooltip/><Legend/><Bar dataKey={yField} name={yField}/></BarChart></ResponsiveContainer>)}
                  {chartType==='line' && (<ResponsiveContainer width="100%" height="100%"><LineChart data={chartData} margin={{top:10,right:20,left:0,bottom:10}}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey={xField}/><YAxis/><Tooltip/><Legend/><Line type="monotone" dataKey={yField} dot={true}/></LineChart></ResponsiveContainer>)}
                  {chartType==='scatter' && (<ResponsiveContainer width="100%" height="100%"><ScatterChart margin={{top:10,right:20,left:0,bottom:10}}><CartesianGrid strokeDasharray="3 3"/><XAxis type="number" dataKey="x" name={xField}/><YAxis type="number" dataKey="y" name={yField}/><Tooltip cursor={{strokeDasharray:"3 3"}}/><Legend/><Scatter data={chartData} name={xField+' vs '+yField}/></ScatterChart></ResponsiveContainer>)}
                </div>
              </div>
            </div>
          </section>
        </div>
        {helpOpen && (<div className="fixed inset-0 bg-black/30 grid place-items-center z-40" onClick={()=>setHelpOpen(false)}><div className="bg-white rounded-2xl shadow-xl max-w-2xl w-full p-5" onClick={e=>e.stopPropagation()}><h3 className="text-lg font-semibold">빠른 안내</h3><ol className="list-decimal pl-5 mt-2 space-y-1 text-sm text-slate-700"><li>반 선택 또는 추가</li><li><b>필드 설정</b>에서 숫자/텍스트 항목 추가</li><li>입력 후 제출 → 표/그래프 확인</li><li><b>⚙ Firebase</b>에 JSON 붙여넣으면 여러 기기 실시간</li></ol><div className="mt-4 text-right"><button className="px-4 py-2 rounded-xl border" onClick={()=>setHelpOpen(false)}>닫기</button></div></div></div>)}
        {fieldPanelOpen && (<div className="fixed inset-0 bg-black/30 grid place-items-center z-40" onClick={()=>setFieldPanelOpen(false)}><div className="bg-white rounded-2xl shadow-xl max-w-xl w-full p-5" onClick={e=>e.stopPropagation()}><h3 className="text-lg font-semibold">필드 설정(교사용)</h3><div className="mt-3 space-y-2">{fields.map(f=>(<div key={f.id} className="flex items-center gap-2 p-2 border rounded-xl"><span className="text-sm font-medium flex-1">{f.name} <span className="text-xs text-slate-500">({f.type})</span></span><button className="px-2 py-1 border rounded-lg text-xs" onClick={()=>renameField(f.id)}>이름변경</button><button className="px-2 py-1 border rounded-lg text-xs" onClick={()=>removeField(f.id)}>삭제</button></div>))}<div className="flex gap-2 pt-2"><button className="px-3 py-2 rounded-xl border" onClick={()=>addField('number')}>+ 숫자 필드</button><button className="px-3 py-2 rounded-xl border" onClick={()=>addField('text')}>+ 텍스트 필드</button></div></div><div className="mt-4 text-right"><button className="px-4 py-2 rounded-xl border" onClick={()=>setFieldPanelOpen(false)}>완료</button></div></div></div>)}
        {settingsOpen && (<div className="fixed inset-0 bg-black/30 grid place-items-center z-40" onClick={()=>setSettingsOpen(false)}><div className="bg-white rounded-2xl shadow-xl max-w-2xl w-full p-5" onClick={e=>e.stopPropagation()}><h3 className="text-lg font-semibold">실시간 사용을 위한 Firebase 설정</h3><p className="text-sm text-slate-600 mt-1">Firebase 콘솔 → 프로젝트 설정 → <b>웹 앱</b> 구성(JSON) 붙여넣기</p><textarea className="mt-3 w-full h-40 border rounded-xl p-3 font-mono text-xs" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}' defaultValue={JSON.stringify(loadLS(LS_KEYS.firebase, {})||{}, null, 2)} onBlur={async (e)=>{ try{ const obj=JSON.parse(e.target.value||'{}'); saveLS(LS_KEYS.firebase, obj); const ok=await initFirebaseIfNeeded(obj); alert(ok?'Firebase 연결 완료':'Firebase 초기화 실패/설정 불완전'); window.location.reload(); }catch(err){ alert('올바른 JSON이 아닙니다.'); } }}></textarea><div className="mt-3 text-right"><button className="px-4 py-2 rounded-xl border" onClick={()=>setSettingsOpen(false)}>닫기</button></div><p className="mt-3 text-xs text-slate-500">* 수업 후 Firestore 보안 규칙을 강화하세요.</p></div></div>)}
      </div>);}
    const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<LabCollector/>);
  </script>
</body>
</html>